完整的跨链 + LP 流程

┌─────────────────────────────────────────────────────────────────┐
│                     源链 (Chain A)                               │
├─────────────────────────────────────────────────────────────────┤
│ 用户操作: 发起跨链转账                                            │
│ ├─ ETH 转账 → InitiateETH 事件                                   │
│ └─ USDT 转账 → InitiateERC20 事件                                │
│                                                                  │
│ 存入数据库: bridge_initiate (Status=0)                           │
└─────────────────────────────────────────────────────────────────┘
↓
┌─────────────────────────────────────────────────────────────────┐
│                     Relayer 节点                                 │
├─────────────────────────────────────────────────────────────────┤
│ 1. ProcessPoolManagerEvent() 解析 Initiate 事件                  │
│ 2. 查询 LP 流动性池是否有足够资金                                 │
│ 3. 构建目标链交易                                                │
│ 4. 调用目标链 PoolManager.finalize()                            │
└─────────────────────────────────────────────────────────────────┘
↓
┌─────────────────────────────────────────────────────────────────┐
│                     目标链 (Chain B)                             │
├─────────────────────────────────────────────────────────────────┤
│ Relayer 调用 finalize()                                          │
│ ├─ 转账 ETH → FinalizeETH 事件                                   │
│ └─ 转账 ERC20 → FinalizeERC20 事件                               │
│                                                                  │
│ 存入数据库: bridge_finalize (Status=0)                           │
└─────────────────────────────────────────────────────────────────┘
↓
┌─────────────────────────────────────────────────────────────────┐
│                     Relayer 节点                                 │
├─────────────────────────────────────────────────────────────────┤
│ 5. ProcessPoolManagerEvent() 解析 Finalize 事件                  │
│ 6. 更新 bridge_record 状态为完成 (Status=1)                      │
│ 7. 标记 bridge_initiate 已处理                                   │
└─────────────────────────────────────────────────────────────────┘

LP 流动性挖矿流程

┌─────────────────────────────────────────────────────────────────┐
│                     LP 提供者操作                                │
├─────────────────────────────────────────────────────────────────┤
│ 1. 质押资产                                                      │
│    ├─ stakeETH() → StakingETHEvent                              │
│    └─ stakeERC20() → StarkingERC20Event                         │
│                                                                  │
│    记录: StartPoolId = 当前 Pool ID (例如 #100)                  │
│                                                                  │
│ 2. 等待期间                                                      │
│    - 用户跨链转账产生手续费                                       │
│    - 手续费按比例分配给 LP                                        │
│    - Pool ID 不断增长: #100 → #101 → #102 ...                   │
│                                                                  │
│ 3a. 提取本金和奖励                                               │
│     withdraw() → Withdraw 事件                                   │
│     - EndPoolId = 当前 Pool ID (例如 #150)                       │
│     - Amount = 本金 (1 ETH)                                      │
│     - RewardAmount = Pool #100-#150 的累积奖励 (0.05 ETH)       │
│                                                                  │
│ 3b. 只领取奖励 (本金继续质押)                                     │
│     claimReward() → ClaimReward 事件                             │
│     - RewardAmount = 累积奖励 (0.05 ETH)                         │
│     - 本金继续赚取收益                                           │
└─────────────────────────────────────────────────────────────────┘

pool_manager.go 记录 InitiateETH → 存入 bridge_initiate
2. Relayer 读取 bridge_initiate → 构建跨链消息
3. message_manager.go 记录 MessageSent → 存入 bridge_msg_sent
4. Relayer 提交到目标链
5. pool_manager.go 记录 FinalizeETH → 存入 bridge_finalize
6. message_manager.go 记录 MessageClaimed → 存入 bridge_msg_hash