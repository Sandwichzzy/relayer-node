å®Œæ•´çš„è·¨é“¾ + LP æµç¨‹

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æºé“¾ (Chain A)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç”¨æˆ·æ“ä½œ: å‘èµ·è·¨é“¾è½¬è´¦                                            â”‚
â”‚ â”œâ”€ ETH è½¬è´¦ â†’ InitiateETH äº‹ä»¶                                   â”‚
â”‚ â””â”€ USDT è½¬è´¦ â†’ InitiateERC20 äº‹ä»¶                                â”‚
â”‚                                                                  â”‚
â”‚ å­˜å…¥æ•°æ®åº“: bridge_initiate (Status=0)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Relayer èŠ‚ç‚¹                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. ProcessPoolManagerEvent() è§£æ Initiate äº‹ä»¶                  â”‚
â”‚ 2. æŸ¥è¯¢ LP æµåŠ¨æ€§æ± æ˜¯å¦æœ‰è¶³å¤Ÿèµ„é‡‘                                 â”‚
â”‚ 3. æ„å»ºç›®æ ‡é“¾äº¤æ˜“                                                â”‚
â”‚ 4. è°ƒç”¨ç›®æ ‡é“¾ PoolManager.finalize()                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç›®æ ‡é“¾ (Chain B)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Relayer è°ƒç”¨ finalize()                                          â”‚
â”‚ â”œâ”€ è½¬è´¦ ETH â†’ FinalizeETH äº‹ä»¶                                   â”‚
â”‚ â””â”€ è½¬è´¦ ERC20 â†’ FinalizeERC20 äº‹ä»¶                               â”‚
â”‚                                                                  â”‚
â”‚ å­˜å…¥æ•°æ®åº“: bridge_finalize (Status=0)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Relayer èŠ‚ç‚¹                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5. ProcessPoolManagerEvent() è§£æ Finalize äº‹ä»¶                  â”‚
â”‚ 6. æ›´æ–° bridge_record çŠ¶æ€ä¸ºå®Œæˆ (Status=1)                      â”‚
â”‚ 7. æ ‡è®° bridge_initiate å·²å¤„ç†                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

LP æµåŠ¨æ€§æŒ–çŸ¿æµç¨‹

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     LP æä¾›è€…æ“ä½œ                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. è´¨æŠ¼èµ„äº§                                                      â”‚
â”‚    â”œâ”€ stakeETH() â†’ StakingETHEvent                              â”‚
â”‚    â””â”€ stakeERC20() â†’ StarkingERC20Event                         â”‚
â”‚                                                                  â”‚
â”‚    è®°å½•: StartPoolId = å½“å‰ Pool ID (ä¾‹å¦‚ #100)                  â”‚
â”‚                                                                  â”‚
â”‚ 2. ç­‰å¾…æœŸé—´                                                      â”‚
â”‚    - ç”¨æˆ·è·¨é“¾è½¬è´¦äº§ç”Ÿæ‰‹ç»­è´¹                                       â”‚
â”‚    - æ‰‹ç»­è´¹æŒ‰æ¯”ä¾‹åˆ†é…ç»™ LP                                        â”‚
â”‚    - Pool ID ä¸æ–­å¢é•¿: #100 â†’ #101 â†’ #102 ...                   â”‚
â”‚                                                                  â”‚
â”‚ 3a. æå–æœ¬é‡‘å’Œå¥–åŠ±                                               â”‚
â”‚     withdraw() â†’ Withdraw äº‹ä»¶                                   â”‚
â”‚     - EndPoolId = å½“å‰ Pool ID (ä¾‹å¦‚ #150)                       â”‚
â”‚     - Amount = æœ¬é‡‘ (1 ETH)                                      â”‚
â”‚     - RewardAmount = Pool #100-#150 çš„ç´¯ç§¯å¥–åŠ± (0.05 ETH)       â”‚
â”‚                                                                  â”‚
â”‚ 3b. åªé¢†å–å¥–åŠ± (æœ¬é‡‘ç»§ç»­è´¨æŠ¼)                                     â”‚
â”‚     claimReward() â†’ ClaimReward äº‹ä»¶                             â”‚
â”‚     - RewardAmount = ç´¯ç§¯å¥–åŠ± (0.05 ETH)                         â”‚
â”‚     - æœ¬é‡‘ç»§ç»­èµšå–æ”¶ç›Š                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

pool_manager.go è®°å½• InitiateETH â†’ å­˜å…¥ bridge_initiate
2. Relayer è¯»å– bridge_initiate â†’ æ„å»ºè·¨é“¾æ¶ˆæ¯
3. message_manager.go è®°å½• MessageSent â†’ å­˜å…¥ bridge_msg_sent
4. Relayer æäº¤åˆ°ç›®æ ‡é“¾
5. pool_manager.go è®°å½• FinalizeETH â†’ å­˜å…¥ bridge_finalize
6. message_manager.go è®°å½• MessageClaimed â†’ å­˜å…¥ bridge_msg_hash


è·¨é“¾æ¡¥æ¥ä¸­çš„å“ˆå¸ŒåŒ¹é…æœºåˆ¶
MsgHash (æ¶ˆæ¯å“ˆå¸Œ) - ç›¸åŒçš„ âœ…

// æºé“¾äº‹ä»¶
MsgHash: bridgeMsgSent.MsgHash      // ä¾‹å¦‚: 0x789xyz...

// ç›®æ ‡é“¾äº‹ä»¶
MsgHash: bridgeRelayMsg.MsgHash     // ä¾‹å¦‚: 0x789xyz... (ç›¸åŒ!)

ğŸ¯ MsgHash çš„ç”ŸæˆåŸç†

MsgHash æ˜¯æ ¹æ®è·¨é“¾æ¶ˆæ¯çš„ä¸šåŠ¡å†…å®¹è®¡ç®—å‡ºæ¥çš„å“ˆå¸Œå€¼ï¼Œé€šå¸¸åŒ…å«ï¼š

// æ™ºèƒ½åˆçº¦ä¸­çš„ç¤ºä¾‹ï¼ˆä¼ªä»£ç ï¼‰
MsgHash = keccak256(abi.encodePacked(
sourceChainId,      // æºé“¾ID
destChainId,        // ç›®æ ‡é“¾ID
sourceTokenAddress, // æºä»£å¸åœ°å€
destTokenAddress,   // ç›®æ ‡ä»£å¸åœ°å€
fromAddress,        // å‘é€æ–¹
toAddress,          // æ¥æ”¶æ–¹
amount,             // é‡‘é¢
nonce,              // å”¯ä¸€nonce
fee                 // æ‰‹ç»­è´¹
));


å·¥ä½œæµç¨‹ï¼š
1. ç”¨æˆ·åœ¨æºé“¾å‘èµ·è·¨é“¾äº¤æ˜“ â†’ ç”Ÿæˆ MsgHashï¼ˆåŸºäºæ¶ˆæ¯å†…å®¹ï¼‰
2. Worker åœ¨æºé“¾ç›‘å¬åˆ° BridgeMsgSent äº‹ä»¶ï¼Œä¿å­˜ MsgHash å’Œ SourceTxHash
3. ä¸­ç»§å™¨å°†æ¶ˆæ¯ä¼ é€’åˆ°ç›®æ ‡é“¾ï¼Œç›®æ ‡é“¾éªŒè¯å¹¶ç”Ÿæˆç›¸åŒçš„ MsgHash
4. Worker åœ¨ç›®æ ‡é“¾ç›‘å¬åˆ° BridgeMsgHash äº‹ä»¶ï¼Œé€šè¿‡ç›¸åŒçš„ MsgHash æ‰¾åˆ°åŸå§‹è®°å½•
5. æ›´æ–°è®°å½•ï¼Œæ·»åŠ  DestTxHash


APIç›¸å…³ï¼š
ğŸ”„ API è°ƒç”¨æµç¨‹

HTTP Request
â†“
Routes Layer (Handler)
â”œâ”€ å‚æ•°è§£æ
â”œâ”€ ç¼“å­˜æ£€æŸ¥
â†“
Service Layer
â”œâ”€ å‚æ•°éªŒè¯
â”œâ”€ ä¸šåŠ¡é€»è¾‘
â”œâ”€ è°ƒç”¨ DB æˆ– gRPC
â†“
Response (JSON)

é¢å¤–çš„å®æ—¶é€šé“ï¼š
Worker/Processor
â†“
WebSocket Hub
â†“
Broadcast to all clients




ã€æºé“¾ã€‘ç”¨æˆ·è°ƒç”¨ bridgeInitiate(100 USDT)
â†“
Synchronizer åŒæ­¥äº‹ä»¶
â†“
Event Processor è§£æäº‹ä»¶
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          â”‚                          â”‚
â”‚   Worker æ¨¡å—ä»»åŠ¡1        â”‚   Relayer æ¨¡å—ä»»åŠ¡1       â”‚
â”‚   onProcessMessageSend    â”‚   onBeforeSendFinalizedTxâ”‚
â”‚                          â”‚                          â”‚
â”‚   1. è¯»å– BridgeMsgSent   â”‚   1. è¯»å– BridgeInitiate â”‚
â”‚   2. éªŒè¯ä»£å¸é…ç½®         â”‚   2. æ„é€  bridgeFinalize  â”‚
â”‚   3. åˆ›å»º BridgeRecord    â”‚      äº¤æ˜“                â”‚
â”‚      - Status = 0 (å¾…å®Œæˆ)â”‚   3. é€šè¿‡ DriverEngine   â”‚
â”‚      - SourceTxHash = xxx â”‚      å‘é€äº¤æ˜“åˆ°ç›®æ ‡é“¾    â”‚
â”‚      - DestTxHash = ç©º    â”‚   4. æ›´æ–° BridgeInitiate â”‚
â”‚                          â”‚      - Status = 1        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“                          â†“
ã€ç›®æ ‡é“¾ã€‘bridgeFinalize äº¤æ˜“ä¸Šé“¾
â†“
Synchronizer åŒæ­¥ BridgeFinalize äº‹ä»¶
â†“
Event Processor è§£æäº‹ä»¶
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          â”‚                          â”‚
â”‚   Worker æ¨¡å—ä»»åŠ¡2        â”‚   Relayer æ¨¡å—ä»»åŠ¡2       â”‚
â”‚   onProcessRelayerMessage â”‚   onAfterSendFinalizedTx â”‚
â”‚                          â”‚                          â”‚
â”‚   1. è¯»å– BridgeMsgHash   â”‚   1. è¯»å– BridgeFinalize â”‚
â”‚   2. é€šè¿‡ MsgHash æ‰¾åˆ°    â”‚   2. é€šè¿‡æ¶ˆæ¯é“¾æ¡æ‰¾åˆ°    â”‚
â”‚      å¯¹åº”çš„ BridgeRecord  â”‚      BridgeInitiate      â”‚
â”‚   3. æ›´æ–° BridgeRecord    â”‚   3. æ›´æ–° BridgeInitiate â”‚
â”‚      - Status = 1 (å®Œæˆ)  â”‚      - Status = 2 (ç¡®è®¤) â”‚
â”‚      - DestTxHash = yyy   â”‚   4. æ›´æ–° BridgeFinalize â”‚
â”‚   4. WebSocket å¹¿æ’­é€šçŸ¥   â”‚      - Status = 1        â”‚
â”‚                          â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
âœ… è·¨é“¾å®Œæˆ